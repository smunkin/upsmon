# upsmon
Скрипт предназначен для мониторинга параметров ИБП APC SmartUPS RT3000 в системе мониторинга Zabbix через Serial порт.

Для правильной работы скрипта требуется:
1. Установить необходимые пакеты зависимостей.
2. Подключить Serial кабель к ИБП и серверу.
3. Настройить minicom, проверить работоспособность и получение данных.
4. Указать переменные в скрипте.
5. Настроить и перезапустить zabbix-agent
6. Добавление скрипта в планировщик задач.
7. Создать шаблон и элементы данных на Zabbix сервере.

1. Установка необходимых пакетов.
Для правильной работы скрипта потребуется установка пакетов:
- minicom
- expect
- lrzsz
- zabbix_sender (входит в состав zabbix-agent, подробнее тут https://www.zabbix.com/documentation/current/en/manual/installation/)

Для Ubuntu:
sudo apt install minicom expect lrzsz zabbix-agent

2. Подключите Serial кабель APC к ИБП.
Типы кабелей для определенной модели ИБП можно посмотреть на сайте производителя. 

3. Настройка minicom.
Запускаем minicom от суперпользователя
minicom -s
Переходим в пункт "Настройка последовательного порта", указываем "Последовательный порт" (прим. /dev/ttyS0 или /dev/ttyUSB0), указываем "Скорость/Чётность/Биты" (прим. 9600 8N1). Выходим из настроек. Выбираем пункт "Сохранить как dfl" и выходим из minicom.

4. Переменные в скрипте.
В скрипте Вам понадобится указать Ваши переменные:
tmpfile - путь, по которому будет хранится файл "сырых" данных, полученных с ИБП.
serialport - Serial порт, который Вы указывали при настройке minicom  (прим. /dev/ttyS0 или /dev/ttyUSB0)
serveraddress - IP адрес сервера Zabbix

5. Настройка Zabbix агента
Для настройки Zabbix агента Вам необходимо отредактировать файл /etc/zabbix/zabbix_agentd.conf и изменить строку
Server=127.0.0.1
на адрес Вашего сервера Zabbix.
Далее необходимо перезапустить zabbix-agent
sudo systemctl restart zabbix-agent

6. Добавление скрипта в планировщик задач.
Для того чтобы добавить скрипт в планировщик задач выполните следующее (от суперпользователя)
# crontab -e
В самом низу добавляем
* * * * * /путь_к_скрипту/apc.sh
И сохраняем изменения.

7. Создание шаблона на Zabbix сервере. 
- На сервере Zabbix необходимо создать узел сети "APC SmartUPS RT3000". Обратите внимание, что узел сети должен называться так же как и в скрипте, для того чтобы zabbix_sender мог отправить ему данные. 
- В шаблонах создаем новый шаблон, с произвольным названием и в настройках узла сети "APC SmartUPS RT3000" добавляем ему этот шаблон.
- В шаблоне создаем элемент данных, к примеру "Battery Run Time". Тип элемента данных указываем "Zabbix траппер", ключ "ups.brt", тип информации "Числовой (с плавающей точкой)"



